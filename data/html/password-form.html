<link rel="stylesheet" type="text/css" href="../css/form-styles.css">
<form class="classical">
	<table>
		<tr>
			<td colspan="2"><h1 id="formCaseName">Password Reset - Performed</h1><br></td>
		</tr>
		<tr>
			<td><label for="clientName">Client:</label></td>
			<td><label for="quickAction">Quick Actions:</label></td>
		</tr>
		<tr>
			<td>
				<div id="client">
					<input type="text" id="clientName" name="clientName" placeholder="Client" value="">
					<input type="hidden" id="clientId" name="clientId" value="">
					<input type="button" id="openSearch" value="Go">
				</div>
			</td>
			<td>
				<select id="quickAction" style="width:100%;" name="quickAction">
					<option>Password Reset - Performed</option>
					<option>Password Reset - Not Performed</option>
					<option>Gmail Question</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>
				<div id="ldapSearchForm">
					<label>
						<span>uid:</span>
						<input type="text" name="field_0" value tabindex="1">
					</label>

					<label>
						<span>First Name:</span>
						<input type="text" name="field_1" value>
					</label>

					<label>
						<span>Last Name:</span>
						<input type="text" name="field_2" value>
					</label>

					<label>
						<span>ID Number:</span>
						<input id="defaultInput" type="text" name="field_3" value tabindex="2">
					</label>

					<label>
						<span>Email Address:</span>
						<input type="text" name="field_4" value>
					</label>
					<div class="hCenter">
						<input type="button" id="ldapSearchBtn" value="Search LDAP">
					</div>
				</div>
			</td>
			<td>
				<label>
					<span>Source:</span>
					<select name="source">
						<option value="PHONE" selected>Phone</option>
						<option value="CHAT">Chat</option>
						<option value="IN_PERSON">In Person</option>
					</select>
				</label>
				<label>
					<span>Impact:</span>
					<select name="impact">
						<option value="High  - Unable to work">High</option>
						<option value="Medium - Can work, difficult workaround" selected>Medium</option>
						<option value="Low - Minor issue">Low</option>
					</select>
				</label>
				<label>
					<span>Priority:</span>
					<select name="priority">
						<option value="CRITICAL">Critical</option>
						<option value="HIGH">High</option>
						<option value="MEDIUM" selected>Medium</option>
						<option value="LOW">Low</option>
					</select>
				</label>
				<label>
					<span>Location:</span>
					<select name="location">
						<option value="Office/Building">Office/Building</option>
						<option value="Off-campus" selected>Off-Campus</option>
					</select>
				</label>
			</td>
		</tr>
		<tr>
			<td colspan="2"><div id="ldapResults"></div></td>
		</tr>
		<tr>
			<td><label for="caseDetails">Case Details:</label></td>
			<td></td>
		</tr>
		<tr>
			<td><textarea id="caseDetails" cols="40" rows="6" tabindex="3">User requested password reset.</textarea></td>
			<td style="vertical-align:top;">
				<input type="button" id="formCreateBtn" value="Create/Close" tabindex="5">
				<input type="button" id="formManualBtn" value="Manual" tabindex="6">
			</td>
		</tr>
		<tr>
			<td><label for="resolutionDetails">Resolution Details:</label></td>
			<td></td>
		</tr>
		<tr>
			<td><textarea id="resolutionDetails" cols="40" rows="6" tabindex="4">Verified user. Temporary password provided.</textarea></td>
			<td style="vertical-align:top;"><input type="button" id="formCancelBtn" value="Cancel" tabindex="7"></td>
		</tr>
	</table>
</form>
<div id="hiddendiv"></div>




<script>
var returnedUsers = [];
var currentUser = 0;

var caseName = "Password Reset - Performed";
var prodCatName = "/Account/Password/Reset performed/";
var prodCatId = "716";
var caseDetails = "User requested password reset.";
var resolutionDetails = "Verified user. Temporary password provided.";
var resolutionCode = "FIX_PROVIDED";
var problemCode = "SR";

$('#quickAction').on('change', function(){
	if($(this).val() == "Password Reset - Performed") {
		caseName = "Password Reset - Performed";
		prodCatName = "/Account/Password/Reset performed/";
		prodCatId = "716";
		caseDetails = "User requested password reset.";
		resolutionDetails = "Verified user. Temporary password provided.";
		resolutionCode = "FIX_PROVIDED";
		problemCode = "SR";
		
		$('#formCaseName').html(caseName);
		$('select[name=source]').val("PHONE");
		$('select[name=impact]').val("Medium - Can work, difficult workaround");
		$('select[name=priority]').val("MEDIUM");
		$('select[name=location]').val("Off-campus");
		$('#caseDetails').val(caseDetails);
		$('#resolutionDetails').val(resolutionDetails);

	} else if($(this).val() == "Password Reset - Not Performed") {
		caseName = "Password Reset - Not Performed";
		prodCatName = "/Account/Password/Reset not performed/";
		prodCatId = "715";
		caseDetails = "User requested password reset.";
		resolutionDetails = "Unable to verify user or password reset was not necessary.";
		resolutionCode = "NO_ACTION";
		problemCode = "SR";
		
		$('#formCaseName').html(caseName);
		$('select[name=source]').val("PHONE");
		$('select[name=impact]').val("Medium - Can work, difficult workaround");
		$('select[name=priority]').val("MEDIUM");
		$('select[name=location]').val("Off-campus");
		$('#caseDetails').val(caseDetails);
		$('#resolutionDetails').val(resolutionDetails);

	} else if($(this).val() == "Gmail Question") {
		caseName = "Gmail Question";
		prodCatName = "/Email/Gmail/";
		prodCatId = "401";
		caseDetails = "User requested email address.";
		resolutionDetails = "Email address provided.";
		problemCode = "FIX_PROVIDED";
		problemCode = "INFO";
		
		$('#formCaseName').html(caseName);
		$('select[name=source]').val("PHONE");
		$('select[name=impact]').val("Medium - Can work, difficult workaround");
		$('select[name=priority]').val("MEDIUM");
		$('select[name=location]').val("Off-campus");
		$('#caseDetails').val(caseDetails);
		$('#resolutionDetails').val(resolutionDetails);
	}
});

$('#defaultInput').focus();

$('#formCancelBtn').on('click', function() {
	$('#formPopup').hide();
});

$('#formCreateBtn').on('click', function() {
	if($('#clientId').val()) {
		createCase();
	} else {
		alert("No client!");
	}
});

$('#formManualBtn').on('click', function() {
	if($('#clientId').val()) {
		chrome.storage.local.set({'currentClient': returnedUsers[currentUser]});
	}
	window.open('https://techsupport.csun.edu/ozSptCaseNew.jsp', '_self');
});

$('#ldapSearchForm input[type="text"]').keyup(function(event) {
	if(event.keyCode == 13) {
		$('#ldapSearchBtn').click();
	}
});

$('#openSearch').on('click', function() {
	$('#ldapSearchForm').slideToggle('slow');
});

$('#ldapSearchBtn').on('click', function(){
	var searchString = "field_0="+$('input[name="field_0"]').val()+
		"&field_1="+$('input[name="field_1"]').val()+
		"&field_2="+$('input[name="field_2"]').val()+
		"&field_3="+$('input[name="field_3"]').val()+
		"&field_4="+$('input[name="field_4"]').val()+
		"&submitBtn=Search"+
		"&ahsFormAction=search"+
		"&lovcontact=Y";

	$.ajax({
		url: 'https://techsupport.csun.edu/ozSlsLOVContactLDAPSearch.jsp',
		data: searchString,
		type: 'POST',
		beforeSend: function() {
			showLoader($('#ldapResults'), 'medium');
		},
		success: function(data) {
			var usersTable = $(data).filter('table:eq(1)');
			usersTable.find('tr:eq(0)').remove();
			var resultTable = '<table id="results"><tr id="resultsHeader"><td>save</td><td>uid</td><td>name</td><td>email</td><td>emplID</td></tr>';
			returnedUsers = [];

			usersTable.find('tr').each(function(i){
				var user = {
					uid: $(this).find('td:eq(12)').html(),
					dn: $(this).find('td:eq(4)').html(),
					email: $(this).find('td:eq(5)').html(),
					emplId: $(this).find('td:eq(7)').html()
				};
				var userRow = '<tr><td><a href="#" class="saveUser" uid="'+ user.uid +'">Save</a></td><td>'+ user.uid +'</td><td>'+ user.dn +'</td><td>'+ user.email +'</td><td>'+ user.emplId +'</td></tr>';
				resultTable += userRow;
				returnedUsers.push(user);
			});

			if(returnedUsers.length == 0) {
				resultTable += "<tr><td colspan='5'><div style='width:100px;margin:auto;'>No users found</div></td></tr>"
			}
			resultTable += '</table>';

			$('#ldapResults').html(resultTable);
			$('.saveUser').on('click', function(){
				saveUser($(this).attr('uid'), $(this).parent());
			});
			
			if(returnedUsers.length == 1) {
				$('.saveUser').click();
			}
		},
		error: function() {
			alert("There was an error submitting the search.");
		}

	});
});

function createCase() {
	caseDetails = $('#caseDetails').val();
	resolutionDetails = $('#resolutionDetails').val();
	resolutionDetails = encodeURIComponent(resolutionDetails);

	var source = $('select[name=source]').val();
	var impact = $('select[name=impact]').val();
	var priority = $('select[name=priority]').val();
	var location = $('select[name=location]').val();

	var user = returnedUsers[currentUser];
	var clientName = user.clientName;
	var clientId = user.clientId;
	var email = user.email;

	var formData = new FormData();
		formData.append('caseName', caseName); // Case Name *Required
		formData.append('customerName','');
		formData.append('customerId','');
		formData.append('contactName', clientName); // Contact Name *Required
		formData.append('contactId', clientId); // Contact ID *Required
		formData.append('divContactType','NORMAL'); // UNKNOWN
		formData.append('cbExtViewable','Y'); // Externally Viewable Checkbox
		formData.append('ownerId', userId); // UNKNOWN - Case Creator?
		formData.append('SOURCE', source); // Source
		formData.append('__SOURCE','Y');
		formData.append('CF_188',''); // Requested Start Date
		formData.append('CF_188_id','');
		formData.append('__CF_188','Y');
		formData.append('STATUS','RECEIVED');
		formData.append('__STATUS','Y');
		formData.append('expCloseDate',''); // Requested Completion Date
		formData.append('__EXP_CLOSE_DATE','Y');
		formData.append('__CF_ENTITY_FIELD_13',''); // UNKNOWN
		formData.append('CF_13_id','');
		formData.append('__CF_13','Y');
		formData.append('CF_1',''); // IP Address
		formData.append('CF_1_id','');
		formData.append('__CF_1','Y');
		formData.append('PRIORITY', priority); // Priority
		formData.append('__PRIORITY','Y');
		formData.append('CF_2',''); // Hardware Address
		formData.append('CF_2_id','');
		formData.append('__CF_2','Y');
		formData.append('CF_91', impact); // Impact *Required
		formData.append('CF_91_id','');
		formData.append('__CF_91','Y');
		formData.append('CF_27',''); // DNS Name
		formData.append('CF_27_id','');
		formData.append('__CF_27','Y');
		formData.append('prodName', prodCatName); // Product/Category *Required
		formData.append('prdCatId', prodCatId); // Product/Category ID *Required
		formData.append('prdId','-1');
		formData.append('__PRODUCT','Y');
		formData.append('attachFile',''); // Attachments
		formData.append('attachFile2','');
		formData.append('attachFile3','');
		formData.append('attachFile4','');
		formData.append('PROBLEM_DESC', caseDetails); // Case Details *Required
		formData.append('__PROBLEM_DESC','Y');
		formData.append('CF_39', email); // Preferred Email Address
		formData.append('CF_39_id','');
		formData.append('__CF_39','Y');
		formData.append('CF_5', location); // Location Type *Required
		formData.append('CF_5_id','');
		formData.append('__CF_5','Y');
		formData.append('CF_40',''); // Preferred Phone Number
		formData.append('CF_40_id','');
		formData.append('__CF_40','Y');
		formData.append('CF_7',''); // Building
		formData.append('CF_7_id','');
		formData.append('__CF_7','Y');
		formData.append('CF_12',''); // Web Site
		formData.append('CF_12_id','');
		formData.append('__CF_12','Y');
		formData.append('CF_10',''); // Room
		formData.append('CF_10_id','');
		formData.append('__CF_10','Y');
		formData.append('PROBLEM_CODE', problemCode); // Problem Code
		formData.append('__PROBLEM_CODE','Y');
		formData.append('qas','');
		formData.append('astid','-1');
		formData.append('projectId','-1');
		formData.append('iclid','0');
		formData.append('pcseid','-1');
		formData.append('ahsFormAction','createCase');

	$('#buttonBar').append('<div style="width:25px;height:21px;padding-top:4px;float:left;" uid="'+ returnedUsers[currentUser].uid +'" class="caseProgress">Case</div>');
	$('.caseProgress').last().button();
	showLoader($('.caseProgress').last(), 'small');

	var caseNumber = "";

	// Create the case
	// alert("Creating case from form data");
	$.ajax({
		url: 'https://techsupport.csun.edu/ozSptCaseNew.jsp',
		data: formData,
		processData: false,
		contentType: false,
		type: 'POST',
		success: function(data) {
			var link = $(data).find('a:eq(0)').attr('href');
			var caseId = link.substring(25,31);
			link = 'https://techsupport.csun.edu/ozSptCaseClose.jsp?id=' + caseId;

			// alert("Grabbing the Close Case data.");
			// Grab the case ID from the redirect page and use that to access the "close case" page
			$.ajax({
				url: link,
				success: function(data) {
					var pageData = $(data);
					var emailTo = pageData.find('input[name=emailTo]').val();
					var emailSubject = pageData.find('input[name=emailSubject]').val();
					var emailContent = pageData.find('textarea[name=emailContent]').html();
					var closeCaseData = "caseOwnerId="+userId+
						"&caseStatus=CLOSED"+
						"&resolutionCode="+resolutionCode+
						"&resolutionDetail="+resolutionDetails+
						"&caseComment="+
						"&PROBLEM_CODE="+problemCode+
						"&__PROBLEM_CODE=Y"+
						"&sendEmail=Y"+
						"&fromAddr=1998"+
						"&emailTo="+emailTo+
						"&ccId=-1"+
						"&emailSubject="+emailSubject+
						"&emailContent="+emailContent+
						"&cbAddEmailToLog=Y"+
						"&addNoteCase=Y"+
						"&addNoteCustomer=Y"+
						"&addNoteContact=Y"+
						"&addNoteSubject="+
						"&addNoteContent="+
						"&taskName="+
						"&ownerId="+userId+
						"&dueDate="+
						"&taskDetail="+
						"&surveyId=-1"+
						"&surveyEmlTo="+emailTo+
						"&surveyEmlSubject="+
						"&surveyEmlContent="+
						"&cbAddSurveyEmlToLog=Y"+
						"&ahsFormAction=updateClose"+
						"&id="+caseId+
						"&commentstatusdirty=Y"+
						"&commentdirty=Y";

					// Close the case with the scraped data
					$.ajax({
						url: 'https://techsupport.csun.edu/ozSptCaseClose.jsp',
						data: closeCaseData,
						type: 'POST',
						success: function(data) {
							$('.caseProgress').each(function(){
								if($(this).attr('uid') == user.uid) {
									var caseUrl = 'https://techsupport.csun.edu/ozSptCaseDtn.jsp?id='+caseId+'&cpos=1';
									$(this).html('&#10003;');
									$(this).attr('href', caseUrl)
									$(this).on('click', function() {
										window.open($(this).attr('href'));
									});
								}
							});
						},
						error: function () {
							alert("Error closeing case.");
						}
					});
				},
				error: function() {
					alert("Error loading the close case page.");
				}
			});
		},
		error: function() {
			alert("An error occured while submitting the case.");
		}
	});
	$('#formPopup').hide();
}

function showLoader(element, size) {
	var loaderGifUrl = chrome.extension.getURL('data/images/ajax-loader.gif');
	var loaderGifSmallUrl = chrome.extension.getURL('data/images/ajax-loader-small.gif');
	if(size == "medium") $(element).html('<img style="display:block;margin:auto;" src="'+ loaderGifUrl +'">');
	if(size == "small") $(element).html('<img style="display:block;margin:auto;" src="'+ loaderGifSmallUrl +'">');
}

function saveUser(uid, element) {
	for(var i = 0; i < returnedUsers.length; i++) {
		if(returnedUsers[i].uid == uid) {
			currentUser = i;
		}
	}
	showLoader($(element), 'small');

	var user = returnedUsers[currentUser];

	var getStr = 'act=SAVE&lovcontact=Y&uid=' + uid;
	$.ajax({
		url: 'https://techsupport.csun.edu/ozSlsLOVContactLDAPSearch.jsp',
		data: getStr,
		success: function(data) {
			$(element).html("Saved");
			var div = jQuery("<div/>");
			div.html(data);
			var scriptTag = div.find('script').last().html();
			var match = /function/.exec(scriptTag);
			scriptTag = scriptTag.substring(0, match.index);
			var varArray = scriptTag.split("'");

			user.clientName = varArray[3];
			user.clientId = varArray[1];
			$('#clientName').val(varArray[3]);
			$('#clientId').val(varArray[1]);
			// $('#ldapResults').empty();
			// $('#ldapSearchForm').slideUp('slow');

			$('#pwSetY').checked;
			$('#pwSetY').focus();
		}
	});
}
</script>